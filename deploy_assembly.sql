/******************************************************************************************************
  * Author:     Mario Muja
  * Created:	2019-09-02
  * Purpose:    register an assembly and procedure for XSL tranformations
  ******************************************************************************************************/ 
use Core
go

-- some configuration changes
EXEC sp_configure 'show advanced options', 1;
GO
RECONFIGURE;
GO
EXEC sp_configure 'clr strict security', 0;
GO
RECONFIGURE;
GO
sp_configure 'clr enabled', 1;
GO
RECONFIGURE
GO

-- drop objects if already exist
if OBJECT_ID('sp_transform') is not null
drop procedure sp_transform
go

IF  EXISTS (SELECT * FROM sys.assemblies asms
WHERE asms.name = N'StoredProcedures')
    DROP ASSEMBLY [StoredProcedures]
GO

/* used this Powershell to get the bits 

"0x" +[System.BitConverter]::ToString([System.IO.File]::ReadAllBytes("C:\code\sql2xml2csv\SqlTransform\SqlTransform\bin\Debug\StoredProcedures.dll")).Replace("-","")

*/

-- create a SQL Server assembly from the .NET assembly
CREATE ASSEMBLY StoredProcedures
FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C01030099C8C6DA0000000000000000E00022200B013000000A00000006000000000000B6290000002000000040000000000010002000000002000004000000000000000600000000000000008000000002000000000000030060850000100000100000000010000010000000000000100000000000000000000000612900004F000000004000009803000000000000000000000000000000000000006000000C000000C8280000380000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000BC09000000200000000A000000020000000000000000000000000000200000602E72737263000000980300000040000000040000000C0000000000000000000000000000400000402E72656C6F6300000C000000006000000002000000100000000000000000000000000000400000420000000000000000000000000000000095290000000000004800000002000500402100008807000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001B300400980000000100001100731000000A0A04731100000A0B0007281200000A0C0006086F1300000A0000DE0B082C07086F1400000A00DC00DE0B072C07076F1400000A00DC03731100000A0D0009281200000A130400731500000A1305000611041411056F1600000A000211056F1700000A5100DE0D11052C0811056F1400000A00DC00DE0D11042C0811046F1400000A00DC00DE0B092C07096F1400000A00DC2A01400000020016000C22000B0000000002000E002230000B0000000002005300196C000D0000000002004B00317C000D00000000020042004A8C000B000000002202281800000A002A00000042534A4201000100000000000C00000076342E302E33303331390000000005006C0000006C020000237E0000D80200006003000023537472696E6773000000003806000004000000235553003C0600001000000023475549440000004C0600003C01000023426C6F620000000000000002000001471502000900000000FA0133001600000100000019000000020000000200000003000000180000000F000000010000000100000003000000000007020100000000000600590107030600C601070306007700D5020F002703000006009F00680206003C01680206001D0168020600AD0168020600790168020600920168020600CC00680206008B00E80206006900E8020600000168020600E700E401060047033F020A00B600B4020E004602300206007A022A000E008702180206009C022A00060091022A0006004E003F020E004E0330020600A9022A0000000000010000000000010001000100100036035B02410001000100502000000000960023024D0001003421000000008618CF0206000400020001000A00000002001400000003001D000900CF0201001100CF0206001900CF020A002900CF0210003100CF0210003900CF0210004100CF0210004900CF0210005100CF0210005900CF0210006100CF0215006900CF0210007100CF0210007900CF0210008900CF0206009100CF0206009900CF021000A10062002900910049003000B9005A000600A900CF02060091005E0236008100FE0140008100CF02060020007B0037012E000B0055002E0013005E002E001B007D002E00230086002E002B0098002E00330098002E003B0098002E00430086002E004B009E002E00530098002E005B0098002E006300B6002E006B00E0002E007300ED001A000480000001000000000000000000000000005B02000004000000000000000000000044004000000000000400000000000000000000004400340000000000040000000000000000000000440018020000000000000000003C4D6F64756C653E00726573756C74584D4C00696E707574584D4C007472616E73666F726D58534C0053797374656D2E494F0053797374656D2E44617461006D73636F726C6962004C6F61640049446973706F7361626C6500446973706F73650043726561746500477569644174747269627574650044656275676761626C6541747472696275746500436F6D56697369626C6541747472696275746500417373656D626C795469746C654174747269627574650053716C50726F63656475726541747472696275746500417373656D626C7954726164656D61726B417474726962757465005461726765744672616D65776F726B41747472696275746500417373656D626C7946696C6556657273696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E41747472696275746500417373656D626C794465736372697074696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E7341747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C79436F6D70616E794174747269627574650052756E74696D65436F6D7061746962696C6974794174747269627574650053797374656D2E52756E74696D652E56657273696F6E696E6700546F537472696E670053716C5472616E73666F726D2E646C6C0053797374656D2E586D6C005472616E73666F726D586D6C0053797374656D2E586D6C2E58736C0053797374656D0058736C436F6D70696C65645472616E73666F726D0053716C5472616E73666F726D0053797374656D2E5265666C656374696F6E00537472696E6752656164657200586D6C526561646572005465787452656164657200537472696E675772697465720054657874577269746572004D6963726F736F66742E53716C5365727665722E536572766572002E63746F720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E496E7465726F7053657276696365730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F6465730053746F72656450726F63656475726573004F626A6563740058736C74417267756D656E744C697374000000000000BAFBBCC6DF0F6247AAB5057A0478C5E000042001010803200001052001011111042001010E04200101020E07061249124D1251124D1251125506000112511259052001011251092003011251126112650320000E08B77A5C561934E08907000301100E0E0E0801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010801000701000000001101000C53716C5472616E73666F726D000005010000000017010012436F7079726967687420C2A920203230313900002901002430313962313365612D336630632D346232622D386233392D31323430333964363765663300000C010007312E302E302E3000004901001A2E4E45544672616D65776F726B2C56657273696F6E3D76342E380100540E144672616D65776F726B446973706C61794E616D65122E4E4554204672616D65776F726B20342E38040100000000000000D925ADD700000000020000006100000000290000000B0000000000000000000000000000100000000000000000000000000000005253445372D183047E3D3F4DBCB89EBE0523273C01000000433A5C636F64655C73716C32786D6C326373765C53716C5472616E73666F726D5C53716C5472616E73666F726D5C6F626A5C44656275675C53716C5472616E73666F726D2E70646200892900000000000000000000A329000000200000000000000000000000000000000000000000000095290000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000000000FF25002000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001001000000018000080000000000000000000000000000001000100000030000080000000000000000000000000000001000000000048000000584000003C03000000000000000000003C0334000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001000000000000000100000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B0049C020000010053007400720069006E006700460069006C00650049006E0066006F0000007802000001003000300030003000300034006200300000001A000100010043006F006D006D0065006E007400730000000000000022000100010043006F006D00700061006E0079004E0061006D006500000000000000000042000D000100460069006C0065004400650073006300720069007000740069006F006E0000000000530071006C005400720061006E00730066006F0072006D0000000000300008000100460069006C006500560065007200730069006F006E000000000031002E0030002E0030002E003000000042001100010049006E007400650072006E0061006C004E0061006D0065000000530071006C005400720061006E00730066006F0072006D002E0064006C006C00000000004800120001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020002000320030003100390000002A00010001004C006500670061006C00540072006100640065006D00610072006B00730000000000000000004A00110001004F0072006900670069006E0061006C00460069006C0065006E0061006D0065000000530071006C005400720061006E00730066006F0072006D002E0064006C006C00000000003A000D000100500072006F0064007500630074004E0061006D00650000000000530071006C005400720061006E00730066006F0072006D0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0030002E0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000B83900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
WITH PERMISSION_SET = SAFE;
go

-- create a procedure that calls into the assembly
CREATE or alter PROCEDURE dbo.sp_transform(
    @resultXML nvarchar(max) OUTPUT,
    @inputXML nvarchar(max), 
    @transformXSL nvarchar(max) 
    )
    AS EXTERNAL NAME  StoredProcedures.[SqlTransform.StoredProcedures].TransformXml;
GO

------- Test
---------------------------------------------------
Declare  @resultXML nvarchar(max);

-- some XML
Declare  @inputXML nvarchar(max) = '
<catalog>
    <cd>
		<title>Empire Burlesque</title>
		<artist>Bob Dylan</artist>
		<country>USA</country>
		<company>Columbia</company>
		<price>10.90</price>
		<year>1985</year>
    </cd>
    <cd>
		<title>Hide your heart</title>
		<artist>Bonnie Tyler</artist>
		<country>UK</country>
		<company>CBS Records</company>
		<price>9.90</price>
		<year>1988</year>
    </cd>
</catalog>';

-- some XSL
Declare  @transformXSL nvarchar(max) = '
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="/">
<xsl:for-each select="catalog/cd">
  ''<xsl:value-of select="title"/>'',
  ''<xsl:value-of select="artist"/>'',
  ''<xsl:value-of select="country"/>'',
  ''<xsl:value-of select="company"/>'',
  <xsl:value-of select="price"/>,      
  ''<xsl:value-of select="year"/>'';
      </xsl:for-each>
    </xsl:template>
  </xsl:stylesheet>';

-- transform 
EXEC core.dbo.sp_transform @resultXML out, @inputXML, @transformXSL;

select @resultXML


